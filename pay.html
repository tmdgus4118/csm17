<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <!-- jQuery -->
    <script
      type="text/javascript"
      src="https://code.jquery.com/jquery-1.12.4.min.js"
    ></script>
    <!-- iamport.payment.js -->
    <script
      type="text/javascript"
      src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"
    ></script>
  </head>

  <body>
    <button onclick="requestPay()">ê²°ì œí•˜ê¸°</button>
    <!-- <button onclick="requestPay()">ê²°ì œí•˜ê¸°</button> -->
    <script>
      function pay() {
        $(".receipt").slideUp("slow");
        $(".paid").slideDown("slow");
        requestPay();
      }

      function requestPay() {
        var IMP = window.IMP; // ìƒëµ ê°€ëŠ¥
        IMP.init("imp32512040"); // ì˜ˆ: imp00000000
        // IMP.request_pay(param, callback) ê²°ì œì°½ í˜¸ì¶œ
        let today = new Date();
        var year = today.getFullYear();
        var month = ("0" + (today.getMonth() + 1)).slice(-2);
        var day = ("0" + today.getDate()).slice(-2);
        var hours = ("0" + today.getHours()).slice(-2);
        var minutes = ("0" + today.getMinutes()).slice(-2);
        var seconds = ("0" + today.getSeconds()).slice(-2);
        var merchant_uid_num = `ORD${year + month + day}-${
          hours + minutes + seconds
        }2`;

        IMP.request_pay(
          {
            // param
            pg: "html5_inicis",
            pay_method: "card", // ğŸ’
            merchant_uid: merchant_uid_num, // ğŸ’ ìš°ë¦¬ ì„œë²„ì—ì„œ ìƒì„±í•˜ì—¬ DBì— ì €ì¥, ê³ ìœ  ì£¼ë¬¸ë²ˆí˜¸ë¡œ ê´€ë¦¬ (ì´ë¯¸ ê²°ì œê°€ ìŠ¹ì¸ ëœ(status: paid) merchant_uidë¡œëŠ” ì¬ê²°ì œ ë¶ˆê°€)
            name: "ë…¸ë¥´ì›¨ì´ íšŒì „ ì˜ì", // PGì‚¬ë§ˆë‹¤ ì°¨ì´ê°€ ìˆì§€ë§Œ, 16ìì´ë‚´ë¡œ ì‘ì„± ê¶Œì¥
            amount: 100, // ğŸ’
            //custom_data: {},                      // ê°€ë§¹ì  ì„ì˜ ì§€ì • ë°ì´í„°, ì£¼ë¬¸ê±´ì— ëŒ€í•´ ë¶€ê°€ì •ë³´ë¥¼ ì €ì¥í•  ê³µê°„ì´ í•„ìš”í•  ë•Œ ì‚¬ìš©
            //tax_free: 0,                          // amount ì¤‘ ë©´ì„¸ê³µê¸‰ê°€ì•¡ì— í•´ë‹¹í•˜ëŠ” ê¸ˆì•¡
            //currency: 'KRW',
            //language: 'ko',
            buyer_email: "gildong@gmail.com",
            buyer_name: "í™ê¸¸ë™",
            //buyer_tel: "010-4242-4242",             // ğŸ’
            buyer_addr: "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì‹ ì‚¬ë™",
            buyer_postcode: "01181",
            //notice_url: [],                             // ê´€ë¦¬ì ì½˜ì†”ì—ì„œ ì„¤ì •í•˜ëŠ” Notification URLëŒ€ì‹  ì‚¬ìš©í•  URL, ì£¼ë¬¸ë§ˆë‹¤ ë‹¤ë¥¸ í˜¹ì€ ë³µìˆ˜ì˜ Notification URLì´ í•„ìš”í•œ ê²½ìš° ì‚¬ìš©
          },
          function (rsp) {
            // callback
            console.log("rsp :", rsp);
            if (rsp.success) {
              fetch("http://onecue.cafe24app.com/api/pay/complete", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  imp_uid: rsp.imp_uid,
                  merchant_uid: rsp.merchant_uid,
                }),
              }).then((response) => console.log(response));
            } else {
              // ê²°ì œ ì‹¤íŒ¨ ì‹œ ë¡œì§,
              alert("ê²°ì œì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. ì—ëŸ¬ ë‚´ìš©: " + rsp.error_msg);
            }

            if (false) {
              if (rsp.success) {
                console.log("rsp.success", rsp.success);
                // ê²°ì œ ì„±ê³µ ì‹œ ë¡œì§,
                // jQueryë¡œ HTTP ìš”ì²­ => ìš°ë¦¬ ì„œë²„ì—ì„œ ì²˜ë¦¬í•  ë‚´ìš©....
                // http://onecue.cafe24app.com/api/pay
                jQuery
                  .ajax({
                    url: "http://onecue.cafe24app.com/api/pay/complete", // ì˜ˆ: https://www.myservice.com/payments/complete
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    data: {
                      imp_uid: rsp.imp_uid,
                      merchant_uid: rsp.merchant_uid,
                    },
                  })
                  .done(function (data) {
                    // ê°€ë§¹ì  ì„œë²„ ê²°ì œ API ì„±ê³µì‹œ ë¡œì§
                    jQuery.ajax(".restext").append("ê²°ì¬ë¥¼ ì„±ê³µí–ˆìŠµë‹ˆë‹¤.");
                    console.log("/pay/complete ë¡œ ë¼ìš°íŒ…ëœ ê²°ê³¼" + data);
                  });
              } else {
                // ê²°ì œ ì‹¤íŒ¨ ì‹œ ë¡œì§,
                alert("ê²°ì œì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. ì—ëŸ¬ ë‚´ìš©: " + rsp.error_msg);
              }
            }
          }
        );
      }
    </script>
  </body>
</html>
